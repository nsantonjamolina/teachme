<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue-indigo.min.css" />
		<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>	
		<link rel="stylesheet" href="style.css">
	</head>
<body>
	
<!--Rating dialog -->		


<dialog id="ratingDialog" class="mdl-dialog">
   <!--h6 class="mdl-dialog__title">Valora la clase</h6-->
   
   
   <div class="mdl-dialog__content">
	   <!-- Simple Textfield -->
	   <h5>  Valora tu clase</h5>   
	   <h7>  Elige una nota entre 1 y 10</h7>     
  <div id="notaDesplegable2" class="mdl-textfield mdl-js-textfield">
	  <select id="notaDesplegable">
  		<option value="1">1</option>
  		<option value="2">2</option>
  		<option value="3">3</option>
  		<option value="4">4</option>
  		<option value="5">5</option>
  		<option value="6">6</option>
  		<option value="7">7</option>
  		<option value="8">8</option>
  		<option value="9">9</option>
  		<option value="10">10</option>
	  </select> 
  </div>

   </div>
   <div class="mdl-dialog__actions">
       <!-- Colored raised button -->
		<button onclick="rating(document.getElementById('notaDesplegable').value)" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
			Enviar</button>
	   <button onclick="closeDialog()" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
			Cerrar</button>
	</div>
	
   
</dialog>	
	
<!--Main page -->		
		
<div class="mdl-layout mdl-js-layout">
   <header class="mdl-layout__header">
      <div class="mdl-layout-icon"></div>
      <div class="mdl-layout__header-row">
         <span class="mdl-layout__title" onclick="window.location.href='index.html'">Teach me</span>
         <span class="extraspace">  </span>
         <span class="extraspace">  </span>
         <div class="mdl-layout-spacer"></div>
         <nav class="mdl-navigation">
			
			 <!-- Accent-colored raised button -->	
            <button id="logoutButton" onclick="window.location.href='index.html'" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            Sign out
            <i class="button-righ-icon material-icons">account_circle</i>
            </button>
         </nav>
		  
		  <span class="extraspace"> </span> 
			
      </div>
   </header>
   <div class="mdl-layout__drawer">
   </div>
</div>

<div id="div1ClasesAlumno">
	<h4>Datos del alumno</h4>
	<button id="" onclick=user() class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent"><h8>Edita tus datos</h8></button>
</div>	
	
<div id="div2ClasesAlumno">
	<h4>Próximas clases </h4>
	<table  class="mdl-data-table mdl-js-data-table">
  		<thead>
			<tr>
      			<th class="mdl-data-table__cell--non-numeric">Profesor</th>
      			<th class="mdl-data-table__cell--non-numeric">Fecha</th>
      			<th class="mdl-data-table__cell--non-numeric">Enseña</th>
				<th class="mdl-data-table__cell--non-numeric">Idioma</th>
    		</tr>
  		</thead>
  		<tbody id="proxClas">
  		</tbody>
	</table>
</div>
	
<div id="div3ClasesAlumno">
	<h4>Clases realizadas</h4>
	<table id="delegateTable" class="mdl-data-table mdl-js-data-table">
  		<thead>
			<tr>
      			<th class="mdl-data-table__cell--non-numeric">Profesor</th>
				<th class="mdl-data-table__cell--non-numeric">Fecha</th>
      			<th class="mdl-data-table__cell--non-numeric">Enseña</th>
				<th class="mdl-data-table__cell--non-numeric">Valora a tu profesor</th>
    		</tr>
  		</thead>
  		<tbody id="finClas">
  		</tbody>
	</table>
</div>
	
	<div id="div4ClasesAlumno"> </div>	
	
</body>
	<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
	<script>
  	// Initialize Firebase
  		var config = {
    		apiKey: "AIzaSyCr2wfyL15rtEmQJsy-mGuc3URImSdNraQ",
    		authDomain: "teachme-7ed11.firebaseapp.com",
    		databaseURL: "https://teachme-7ed11.firebaseio.com",
    		projectId: "teachme-7ed11",
    		storageBucket: "teachme-7ed11.appspot.com",
    		messagingSenderId: "147010117223"
  		};
  		firebase.initializeApp(config);
	</script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>	
	<script type='text/javascript' src="functions.js"></script>			
	<script>
		
		// Script para rellenar las tablas con las clases
		
		$("showValoraButton").hide();
		/*
				1. Toma id del alumno, de la url
				2. Toma todas sus clases y guárdalas en un array
				3. Busca las clases de cada uno de los arrays y hazle append en las tablas
				4. Podemos discriminar a partir de la fecha actual
			*/	
				var claseUsuario = [];		
				var idAlumno = user.uid;
				var clase = "noNull";
				var i = 0;
				console.log(idAlumno);
		
		$(document).ready(function(){
			
			var ref = firebase.database().ref();
			ref.once("value").then(function(snapshot){
				// Saco todas las clases que hay en la BD con este idAlumno
				while(clase != null){
					clase = snapshot.child("alumno/"+idAlumno+"/clases/"+clases[i]).val();	
					claseUsuario.push(clase);
					i++;	
				}
				// para que se me quede apuntando justo al último
				i--;
				// Con esto ya voy a leer sólo aquellas clases que coincida el id de la clase
				var idClase = "1";
				while (idClase != null){
					
						idClase = claseUsuario.pop();
						var materia = snapshot.child('clases/'+idClase+'/materia').val();
						var nombre = snapshot.child('clases/'+idClase+'/nombre').val();
						var fecha = snapshot.child('clases/'+idClase+'/fecha').val();
						var idProf = snapshot.child('clases/'+idClase+'/profesorId').val();
						var idAlumno = snapshot.child('clases/'+idClase+'/alumnoId').val();
						var realizada = snapshot.child('clases/'+idClase+'/realizada').val();
				
					if	(realizada == 0){		
							
						$("#proxClas").append("<tr><td class='mdl-data-table__cell--non-numeric' style='text-align: center;'><h6>"+nombre+"</h6></td><td id="+"trteach"+" class='mdl-data-table__cell--non-numeric' style='text-align: center;'><h6>"+materia+"</h6></td><td class='mdl-data-table__cell--non-numeric' style='text-align: center;'>"+fecha+"</td></tr>");
						}else{
							
							
						$("#finClas").append("<tr id="+idProf+"><td class='mdl-data-table__cell--non-numeric' style='text-align: center;'><h6>"+nombre+"</h6></td><td class='mdl-data-table__cell--non-numeric' style='text-align: center;'><h6>"+fecha+"</h6></td><td class='mdl-data-table__cell--non-numeric' style='text-align: center;'><h6>"+materia+"</h6></td><td class='mdl-data-table__cell--non-numeric' style='text-align: center;'><button class='mdl-button mdl-js-button mdl-button--raised mdl-button--colored' onclick='bd()'>Valora tu clase</button></td></tr>");
					
							
						}
			});			
		});
		
			
	</script>
	<script>
		function bd(){
			let table = document.getElementById('delegateTable');
    		let selectedTd;

    		table.onclick = function(event) {
      		let target = event.target;

      		while (target != this) {
        	if (target.tagName == 'TR') {
          		highlight(target);
          	return;
        	}
        	target = target.parentNode;
      		}	
    		}
		}

	</script>
	
	<script>
		
/* MODAL RATING */

var profesor;
		
	function closeDialog(){
		var dialog = document.querySelector('#ratingDialog');
		if (! dialog.showModal) {
      		dialogPolyfill.registerDialog(dialog);
    	}
		dialog.close();
		
	}	
		
	function highlight(node) {
		
		// Guardo quién es el profesor del botón pulsado
		profesor = node.id;
		//document.getElementById("id00").innerHTML = node.id;
			
		var dialog = document.querySelector('#ratingDialog');
  		if (! dialog.showModal) {
      		dialogPolyfill.registerDialog(dialog);
    	}
				
		dialog.showModal();
};
		
		function rating(nota){
			console.log(profesor);
			
			var ref = firebase.database().ref();
			
			ref.once("value").then(function(snapshot){	
			var notaProfPrev = snapshot.child("prof/"+profesor+"/rating").val();	
			var numClases = snapshot.child("prof/"+profesor+"/numClases").val();	
			console.log("notaProfPrev: " + notaProfPrev);
			console.log("numClases: " + numClases);
			console.log("nota spinner: " + nota);	
				
			var newNumClases = numClases+1;
				
				console.log("newNumClases: " + newNumClases);	
				var nota1;
				console.log("nota1: "+nota1);
				nota1 = (+numClases* +notaProfPrev + +nota)/newNumClases;
				console.log("nota1: "+nota1);
				alert("nota1: "+nota1);
				var rutaNotaRef = "prof/"+profesor+"/rating";
				var notaRef = firebase.database().ref(rutaNotaRef);
				notaRef.set(nota);
				var rutaNumClases = "prof/"+profesor+"/numClases";
				var numCRef = firebase.database().ref(rutaNumClases);
				numCRef.set(newNumClases);
				alert("newNumClases "+newNumClases);
			
				
		}
		)};
	
		
</script>
<script>

	
		function user(){
		var user = firebase.auth().currentUser;
		
		if (user !== null) {
			console.log("Desde AA: "+ user.email)
		} else {			
			console.log("Sorry, no hay user");	
		}};


</script>


</html>