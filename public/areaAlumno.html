<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue-indigo.min.css" />
		<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>	
		<link rel="stylesheet" href="style.css">
	</head>
<body>
	
<!--Rating dialog -->		


<dialog id="ratingDialog" class="mdl-dialog">
   <!--h6 class="mdl-dialog__title">Valora la clase</h6-->
   <h5>Valora la clase</h5>
   <div class="mdl-dialog__content">
	   <!-- p id="loginError"></p>

	   <!-- Simple Textfield -->

  <div class="mdl-textfield mdl-js-textfield">
    <input class="mdl-textfield__input" type="Text" id="idSesion">
    <label class="mdl-textfield__label" for="sample1">Id de la sesión</label>
  </div>
	 

	   <!-- Simple Textfield -->
	   
  <div class="mdl-textfield mdl-js-textfield">
	  <select id="notaDesplegable">
  		<option value="1">1</option>
  		<option value="2">2</option>
  		<option value="3">3</option>
  		<option value="4">4</option>
  		<option value="5">5</option>
  		<option value="6">6</option>
  		<option value="7">7</option>
  		<option value="8">8</option>
  		<option value="9">9</option>
  		<option value="10">10</option>
	  </select> 
  </div>

   </div>
   <div class="mdl-dialog__actions">
       <!-- Colored raised button -->
		<button onclick="rating(document.getElementById('idSesion').value,document.getElementById('notaDesplegable').value)" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
			Enviar</button>
	</div>
	<div id="loginProgress" class="mdl-spinner mdl-js-spinner is-active"></div>
   </div>
</dialog>
	
	
<!--Main page -->		
		
<div class="mdl-layout mdl-js-layout">
   <header class="mdl-layout__header">
      <div class="mdl-layout-icon"></div>
      <div class="mdl-layout__header-row">
         <span class="mdl-layout__title" onclick="window.location.href='index.html'">Teach me</span>
         <span class="extraspace">  </span>
         <span class="extraspace">  </span>
         <div class="mdl-layout-spacer"></div>
         <nav class="mdl-navigation">
			
			 <!-- Accent-colored raised button -->
			<span class="extraspace"> </span>
            <button id="logginButton" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            Login
            <i class="button-righ-icon material-icons">account_circle</i>
            </button>
			<span class="extraspace"> </span> 
			 
            <!-- Accent-colored raised button -->
			 <span class="extraspace"> </span>
            	<a href="hp.html">
			 	<button id="profesorButton" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
				Hazte profesor!
            		<i class="button-righ-icon material-icons">account_circle</i>
            	</button>
				</a>	
			<span class="extraspace"> </span> 
			
			 <!-- Accent-colored raised button -->	
            <button id="logoutButton" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            Sign out
            <i class="button-righ-icon material-icons">account_circle</i>
            </button>
         </nav>
		  
		  <span class="extraspace"> </span> 
			
			 <!-- Accent-colored raised button -->	
            <button id="registrateButton" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            Regístrate
            <i class="button-righ-icon material-icons">account_circle</i>
            </button>
         </nav>
      </div>
   </header>
   <div class="mdl-layout__drawer">
   </div>
</div>
<div id="div1ClasesAlumno">
	<h4>Datos del alumno</h4>
	<button id="" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent"><h8>Edita tus datos</h8></button>
	<button id="valora" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent"><h8>Valora tus clases</h8></button>
</div>	
	
<div id="div2ClasesAlumno">
	<h4>Próximas clases </h4>
	<table  class="mdl-data-table mdl-js-data-table">
  		<thead>
			<tr>
      			<th class="mdl-data-table__cell--non-numeric">Profesor</th>
      			<th class="mdl-data-table__cell--non-numeric">Fecha</th>
      			<th class="mdl-data-table__cell--non-numeric">Teach</th>
				<th class="mdl-data-table__cell--non-numeric">Idioma</th>
    		</tr>
  		</thead>
  		<tbody id="proxClas">
  		</tbody>
	</table>
</div>
	
<div id="div3ClasesAlumno">
	<h4>Clases realizadas</h4>
	<table  class="mdl-data-table mdl-js-data-table">
  		<thead>
			<tr>
      			<th class="mdl-data-table__cell--non-numeric">Profesor</th>
      			<th class="mdl-data-table__cell--non-numeric">Teach</th>
				<th class="mdl-data-table__cell--non-numeric">Valora a tu profesor</th>
    		</tr>
  		</thead>
  		<tbody id="finClas">
  		</tbody>
	</table>
</div>
	
	<div id="div4ClasesAlumno"> </div>	
	
</body>
	<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
	<script>
  	// Initialize Firebase
  		var config = {
    		apiKey: "AIzaSyCr2wfyL15rtEmQJsy-mGuc3URImSdNraQ",
    		authDomain: "teachme-7ed11.firebaseapp.com",
    		databaseURL: "https://teachme-7ed11.firebaseio.com",
    		projectId: "teachme-7ed11",
    		storageBucket: "teachme-7ed11.appspot.com",
    		messagingSenderId: "147010117223"
  		};
  		firebase.initializeApp(config);
	</script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script>
		
		// Obtenemos id del profesor
			var url = window.location.href;
			var search = url.split("?");
			var idAlumno = search[1].slice(3);
			
		// Script para rellenar las tablas con las clases
		
		$("showValoraButton").hide();
		/*
				1. Toma id del alumno, de la url
				2. Toma todas sus clases y guárdalas en un array
				3. Busca las clases de cada uno de los arrays y hazle append en las tablas
				4. Podemos discriminar a partir de la fecha actual
			*/	
				var claseUsuario = new Array(null,null,null,null,null,null,null,null,null,null);
				var clases = new Array("clase0", "clase1", "clase2","clase3", "clase4", "clase5","clase6", "clase7", "clase8","clase9");
		
		$(document).ready(function(){
			
			var ref = firebase.database().ref();
			ref.once("value").then(function(snapshot){
				// Saco todas las clases que hay en la BD con este idAlumno
				claseUsuario[0] = snapshot.child("alumno/"+idAlumno+"/"+clases[0]).val();
				claseUsuario[1] = snapshot.child("alumno/"+idAlumno+"/"+clases[1]).val();
				claseUsuario[2] = snapshot.child("alumno/"+idAlumno+"/"+clases[2]).val();
				claseUsuario[3] = snapshot.child("alumno/"+idAlumno+"/"+clases[3]).val();
				claseUsuario[4] = snapshot.child("alumno/"+idAlumno+"/"+clases[4]).val();
				claseUsuario[5] = snapshot.child("alumno/"+idAlumno+"/"+clases[5]).val();
				// Con esto ya voy a leer sólo aquellas clases que coincida el id de la clase
				for (i = 0; i < claseUsuario.length; i++) {
					if(claseUsuario[i] != null ){
						console.log(i);
						var materia = snapshot.child('clases/'+claseUsuario[i]+'/materia').val();
						var nombre = snapshot.child('clases/'+claseUsuario[i]+'/nombre').val();
						var fecha = snapshot.child('clases/'+claseUsuario[i]+'/fecha').val();
						var idProf = snapshot.child('clases/'+claseUsuario[i]+'/id').val();
						console.log("materia "+materia);
						console.log("nombre "+nombre);
						console.log("fecha "+fecha);
						console.log("idProf "+idProf);
						
						var f1 = new Date();
						
						f1.setDate(fecha.slice(0,2));
						f1.setMonth(fecha.slice(2,4));
						f1.setFullYear(fecha.slice(6,10));
						
						var fechaActual = new Date();
						console.log(fechaActual >= f1);
						console.log(fechaActual.getDate() + "/" + (fechaActual.getMonth() +1) + "/" + fechaActual.getFullYear());
						console.log(f1.getDate() + "/" + (f1.getMonth() +1) + "/" + f1.getFullYear());
						
						if(fechaActual < f1){
							
							
						$("#proxClas").append("<tr><td onClick="+"clickFilaProfesor(this.id)"+" class='mdl-data-table__cell--non-numeric' style='text-align: center;'><h6>"+nombre+"</h6></td><td id="+"trteach"+" class='mdl-data-table__cell--non-numeric' style='text-align: center;'><h6>"+materia+"</h6></td><td class='mdl-data-table__cell--non-numeric' style='text-align: center;'>"+fecha+"</td></tr>");
						}else{
							
							
						$("#finClas").append("<tr><td id='hola' onClick='clickFilaProfesor(this.id)' class='patata2 mdl-data-table__cell--non-numeric' style='text-align: center;'><h6>"+nombre+"</h6></td><td id="+"trteach"+" class='mdl-data-table__cell--non-numeric' style='text-align: center;'><h6>"+materia+"</h6></td><td style='text-align: center;' class='mdl-textfield mdl-js-textfield'><button id='pepeB' onClick='prueba()' class='mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent'>Prueba</button></td></tr>");
						
							
						}
					}
				}
			});			
		});
		
			
	</script>
	<script>
//$("#pepeB").click(function(){	
function prueba(){		
		hijo=$("#pepeB");
		padre=hijo.closest("td").prop("id");
		alert(padre.val);
		var idb = $(this).closest(".td").prop("id");
		
}
//);
	</script>
	
	<script>
/* MODAL RATING */

$("#valora").click(
	function(){
			
		var dialog = document.querySelector('#ratingDialog');
  		if (! dialog.showModal) {
      		dialogPolyfill.registerDialog(dialog);
    	}
				
		dialog.showModal();
});
		
		function rating(id,nota){
			alert(nota+"_"+id);
			var ref = firebase.database().ref();
			ref.once("value").then(function(snapshot){
			// Saco id de Prof de la clase
			var idProfRat = snapshot.child("clases/"+id+"/id").val();
			var notaProfPrev = snapshot.child("prof/"+idProfRat+"/rating").val();	
			if(notaProfPrev > nota){
				nota = nota + (notaProfPrev*0.1);
				var rutaNotaRef = "prof/"+idProfRat+"/rating";
				var notaRef = firebase.database().ref(rutaNotaRef);
				notaRef.set(nota);
				alert(nota);
			}
			else if(notaProfPrev < nota){
				nota = nota - (1-(notaProfPrev*0.1));
				var rutaNotaRef = "prof/"+idProfRat+"/rating";
				var notaRef = firebase.database().ref(rutaNotaRef);
				notaRef.set(nota);
				alert(nota);
			}
			else {alert("Gracias por valorar la sesión: "+id);}	
				
		})}
		
		
		
		

	
		
</script>

	<script type='text/javascript' src="functions.js"></script>		
</html>