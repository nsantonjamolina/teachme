<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue-indigo.min.css" />
		<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>	
		<link rel="stylesheet" href="styles/timetablejs.css">
		<link rel="stylesheet" href="style.css">
		<script src="moment.js"></script> 
		<script src="combodate.js"></script> 
	</head>
<body>
<!--Main page -->		
		
<div class="mdl-layout mdl-js-layout">
   <header class="mdl-layout__header">
      <div class="mdl-layout-icon"></div>
      <div class="mdl-layout__header-row">
         <span class="mdl-layout__title" onclick="window.location.href='index.html'">Teach me</span>
         <span class="extraspace">  </span>
         <span class="extraspace">  </span>
         <div class="mdl-layout-spacer"></div>
         <nav class="mdl-navigation">
			
			 <!-- Accent-colored raised button -->
			<span class="extraspace"> </span>
            <button id="logginButton" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            Login
            <i class="button-righ-icon material-icons">account_circle</i>
            </button>
			<span class="extraspace"> </span> 
			 
            <!-- Accent-colored raised button -->
			 <span class="extraspace"> </span>
            	<a href="hp.html">
			 	<button id="profesorButton" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
				Hazte profesor!
            		<i class="button-righ-icon material-icons">account_circle</i>
            	</button>
				</a>	
			<span class="extraspace"> </span> 
			
			 <!-- Accent-colored raised button -->	
            <button id="logoutButton" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            Sign out
            <i class="button-righ-icon material-icons">account_circle</i>
            </button>
         </nav>
		  
		  <span class="extraspace"> </span> 
			
			 <!-- Accent-colored raised button -->	
            <button id="registrateButton" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            Regístrate
            <i class="button-righ-icon material-icons">account_circle</i>
            </button>
         </nav>
      </div>
   </header>
   <div class="mdl-layout__drawer">
   </div>
</div>
<div id="div1ClasesAlumno">
	<h6>Prueba 1</h6>
</div>
<div id="div2ClasesAlumno">
	<h6>Prueba 2</h6>
</div>
<div id="div3ClasesAlumno">
	<table id="tablaContrataClase" class="mdl-data-table mdl-js-data-table">
  		<thead>
			<tr>
      			<th class="mdl-data-table__cell--non-numeric" style="text-align: center;">Nombre</th>
      			<th class="mdl-data-table__cell--non-numeric" style="text-align: center;">Te voy a enseñar</th>
      			<th class="mdl-data-table__cell--non-numeric" style="text-align: center;">Language</th>
				<th class="mdl-data-table__cell--non-numeric" style="text-align: center;">Video</th>
    		</tr>
  		</thead>
  		<tbody>
			<tr>
				<td id=nameProf class="mdl-data-table__cell--non-numeric" style="text-align: center;"></td>
      			<td id="teachProf" class="mdl-data-table__cell--non-numeric" style="text-align: center;"></td>
      			<td id="langProf" class="mdl-data-table__cell--non-numeric"></td>
				<td  id="video" class="mdl-data-table__cell--non-numeric">
					<!--iframe width="560" height="315" src="https://www.youtube.com/embed/yUzdZ4hAFBs" frameborder="0" allowfullscreen></iframe-->
    		</tr>
  		</tbody>
	</table>
</div>
	
<!--div id="div4ClasesAlumno">
	<h6>Fecha</h6>
	<input type="text" id="fecha_id">
	<!--button id="contratarClase_" class="mdl-button mdl-js-button mdl-button--raised" onclick="contratarClase(document.getElementById('fecha_id').value)"><h8>Contratar</h8></button-->	
	<!--button id = "contratarClase" class="mdl-button mdl-js-button mdl-button--raised" onclick="addEventFromHTML('Jueves','10','12')"><h8>Contratar</h8></button-->

<div id="div4ClasesAlumno">
	<input type="date"/>
</div>	
<div id="div5ClasesAlumno">
	<span></span>
</div>		
	
<div class="timetable"></div>		
<span></span>

</body>

	<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
	<script>
  	// Initialize Firebase
  		var config = {
    		apiKey: "AIzaSyCr2wfyL15rtEmQJsy-mGuc3URImSdNraQ",
    		authDomain: "teachme-7ed11.firebaseapp.com",
    		databaseURL: "https://teachme-7ed11.firebaseio.com",
    		projectId: "teachme-7ed11",
    		storageBucket: "teachme-7ed11.appspot.com",
    		messagingSenderId: "147010117223"
  		};
  		firebase.initializeApp(config);
	</script>

	<script src="scripts/timetable.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script type='text/javascript' src="functions.js"></script>		
	<script>
		// Nos pasan el id en la url, parseamos y hacemos retrieve de esa info en fb
		var url = window.location.href;
		var search = url.split("?");
		var searchfb = search[1].slice(3);
		firebase.database().ref('/prof/' + searchfb).once('value').then(function(snapshot) {
  			var lang = snapshot.val().lang;
			var name = snapshot.val().name;
			var teach = snapshot.val().teach;
			var videourl = snapshot.val().videourl;
		 	
			
		// Muy importante: He añadido un plugin para poder ver el video
		// Si en algún momento se sube a un servidor habrá que revisar este punto
		// Pluggin: Ignore X-Frame headers	
				
		document.getElementById("nameProf").innerHTML = name;
		document.getElementById("langProf").innerHTML = lang;
		document.getElementById("teachProf").innerHTML = teach;
		document.getElementById("video").innerHTML = videourl;
		});
	</script>
	<script>

		// Obtenemos id del profesor
			var url = window.location.href;
			var search = url.split("?");
			var idProfesor = search[1].slice(3);
		
		
		// Función para guardar la clase 
		function getEventFromDB(idProfesor){
			var ref = firebase.database().ref('clases/' + idProfesor); 
			ref.once('value').then(function(snapshot) {
				snapshot.forEach(function(childSnapshot) {
      		// Traigo snapshot y le saco los datos
      		// childData will be the actual contents of the child
      			var location = childSnapshot.val().location;
				var inicio = childSnapshot.val().inicio;
				var final = childSnapshot.val().final;
					
				timetable.addEvent('Ocupado',location, new Date(2017,8,19,inicio,00), new Date(2017,8,19,final,00));	
  				})
				renderer.draw('.timetable');
		})
		}
		
		
		// Función para traer la info que hay en BD
		function addEventFromHTML (dia, horai, minutosi, horaf, minutosf){
			
			var month = Date.now().getMonth();
			Date date = new Date("2017", month, "1", "1", "1");
			
			console.log(date.toDateString);
			
			var postData = "hola";
			var currentUser = firebase.auth().currentUser;
			var uuid = currentUser.uid;
			
			// Añadimos a BD clases
			var ref = firebase.database().ref();	
	
				
			console.log(uuid);
			
			
			// Get a key for a new Post.
  			var newPostKey = firebase.database().ref().child('/clases/' + idProfesor).push().key;
  			// Write the new post's data simultaneously in the posts list and the user's post list.
  			var updates = {};
  			updates['clases/' + idProfesor +'/'+ newPostKey] = postData;
  			updates['alumno/' + uuid + '/' + newPostKey] = postData;

  			return firebase.database().ref().update(updates);	
			
			// Añadimos a la tabla
			timetable.addEvent('Ocupado',dia, new Date(2017,8,19,inicio,00), new Date(2017,8,19,fin,00));
			renderer.draw('.timetable');
		}
		
		
      	var timetable = new Timetable();
		
		
		
		timetable.setScope(9,15);
      	
		timetable.addLocations(['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo']);
		
		getEventFromDB(idProfesor);
		
		var renderer = new Timetable.Renderer(timetable);
		
		renderer.draw('.timetable');
  
    </script>
	<script>
		$(function() {
    		$( "#datepicker" ).datepicker();
		});
	</script>

</html>